#!/usr/bin/env python

# $Id$
# Author: Lea Wiemann <LeWiemann@gmail.com>
# Copyright: This module has been placed in the public domain.

"""
Test for docutils XML writer.
"""

from __init__ import DocutilsTestSupport

import sys
import docutils
import docutils.core

# sample strings:

source = u"""\
Test

----------

Test. \xe4\xf6\xfc\u20ac"""

xmldecl = u"""<?xml version="1.0" encoding="iso-8859-1"?>
"""

doctypedecl = u"""\
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net\
//DTD Docutils Generic//EN//XML"\
 "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
"""

generatedby = u'<!-- Generated by Docutils %s -->\n' % docutils.__version__

bodynormal = u"""\
<document source="&lt;string&gt;"><paragraph>Test</paragraph>\
<transition/><paragraph>Test. \xe4\xf6\xfc&#8364;</paragraph>\
</document>"""

bodynewlines = u"""\
<document source="&lt;string&gt;">
<paragraph>Test</paragraph>
<transition/>
<paragraph>Test. \xe4\xf6\xfc&#8364;</paragraph>
</document>
"""

bodynewlines_old = u"""\
<document source="&lt;string&gt;">
<paragraph>
Test
</paragraph>
<transition/>
<paragraph>
Test. \xe4\xf6\xfc&#8364;
</paragraph>
</document>
"""

bodyindents = u"""\
<document source="&lt;string&gt;">
    <paragraph>Test</paragraph>
    <transition/>
    <paragraph>Test. \xe4\xf6\xfc&#8364;</paragraph>
</document>
"""

bodyindents_old = u"""\
<document source="&lt;string&gt;">
    <paragraph>
        Test
    </paragraph>
    <transition/>
    <paragraph>
        Test. \xe4\xf6\xfc&#8364;
    </paragraph>
</document>
"""

# New formatting introduced in versions 2.7.3 and 3.2.3 on 2011-11-18
# to fix http://bugs.python.org/issue4147
if (sys.version_info < (2, 7, 3) or
    sys.version_info[0] == 3 and sys.version_info < (3, 2, 3)):
    bodynewlines = bodynewlines_old
    bodyindents = bodyindents_old


class DocutilsXMLTestCase(DocutilsTestSupport.StandardTestCase):

    def test_publish(self):
        settings = {'input_encoding': 'utf8',
                    'output_encoding': 'iso-8859-1',
                    '_disable_config': 1}
        for settings['newlines'] in 0, 1:
            for settings['indents'] in 0, 1:
                for settings['xml_declaration'] in 0, 1:
                    for settings['doctype_declaration'] in 0, 1:

                        expected = u''
                        if settings['xml_declaration']:
                            expected += xmldecl
                        if settings['doctype_declaration']:
                            expected += doctypedecl
                        expected += generatedby
                        if settings['indents']:
                            expected += bodyindents
                        elif settings['newlines']:
                            expected += bodynewlines
                        else:
                            expected += bodynormal

                        self.assertEqual(docutils.core.publish_string
                                         (source=source.encode('utf8'),
                                          reader_name='standalone',
                                          writer_name='docutils_xml',
                                          settings_overrides=settings),
                                         expected.encode('latin1'))


if __name__ == '__main__':
    import unittest
    unittest.main()
