#!/bin/sh

IN_DIR=input
OUT_DIR=output
EXP_DIR=expected

if [ -z "`man man|grep -- '^ *-T Format'`" ] ; then
    echo 'ALERT: your man does not support "-T Format" to specify encoding'
    echo 'SKIPPING encoding tests'
    ENCS=""
else
    ENCS="latin1 utf8 ascii"
fi

if [ -z "$1" ] ; then
  FILES=*.txt
else
  FILES=$1
fi

CMD="../../docutils/tools/rst2man.py --traceback"

for IN_F in $IN_DIR/$FILES ; do
  BASE=`basename $IN_F`
  F_BASE=${BASE%.txt}
  if echo $F_BASE | grep -q -- '-de\.' ; then
    OPT="-l de"
  else
    OPT=""
  fi
  $CMD $OPT $IN_F $OUT_DIR/$F_BASE.man
  if [ $? -eq 0 ] ; then
    diff -s -u $EXP_DIR/$F_BASE.man $OUT_DIR/$F_BASE.man
    for ENC in $ENCS ; do
      if [ -e $EXP_DIR/$F_BASE.$ENC ] ; then
        man -T$ENC $OUT_DIR/$F_BASE.man > $OUT_DIR/$F_BASE.$ENC
        diff -s -u $EXP_DIR/$F_BASE.$ENC $OUT_DIR/$F_BASE.$ENC
      fi
    done
  fi
done

if [ -n "$1" ] ; then
    exit
fi

for L in "en" "de" ; do
  for IN_F in $IN_DIR/docinfo-*.txt ; do
    BASE=`basename $IN_F`
    F_BASE=${BASE%.txt}
    OPT="-l $L"
    EXT="-l_$L"
    $CMD $OPT $IN_F $OUT_DIR/$F_BASE$EXT.man
    if [ $? -eq 0 ] ; then
      diff -s -u $EXP_DIR/$F_BASE$EXT.man $OUT_DIR/$F_BASE$EXT.man
    fi
  done
done


