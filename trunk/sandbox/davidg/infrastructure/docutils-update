#! /bin/sh
# $Id$
#
# This script is installed as a cron job to automatically update the
# Docutils web site whenever the CVS files change.  Any .html document
# with a corresponding .txt file is regenerated whenever the .txt
# changes.
#
# Options:
#   -p    Run from the project directory.
#   -u    Regenerate .html unconditionally.

projdir=/home/groups/d/do/docutils
project=docutils
dest=$projdir/htdocs
tmp=$projdir/tmp/$project
pylib=$projdir/lib/python
lib=$pylib/$project

export CVSROOT=:pserver:anonymous@cvs.$project.sourceforge.net:/cvsroot/$project

unconditional=0

while getopts pu opt
do
    case $opt in
        p)  export PYTHONPATH=$pylib:$lib;;
        u)  unconditional=1;;
        \?) exit 2;;
    esac
done
shift `expr $OPTIND - 1`

# prep the tmp area
rm -rf $tmp 2>&1 > /dev/null
mkdir -p $tmp 2>&1 > /dev/null
cd $tmp

# gather the materials
cvs -Q -z3 export -rHEAD $project
cvs -Q -z3 export -rHEAD sandbox
cvs -Q -z3 export -rHEAD web

# remove junk
find -name .cvsignore | xargs rm

# create the snapshots
tar -czf $project-snapshot.tgz $project
tar -czf $project-sandbox-snapshot.tgz sandbox
tar -czf $project-web-snapshot.tgz web

# plant the snapshots
mv *snapshot.tgz $dest

# update htdocs
cd $project
cp -ru . $dest
cd ..
cp -ru sandbox $dest
cd web
cp -ru . $dest

# destroy the evidence
cd
rm -rf $tmp

# update library area
cd $lib/web
cvs -Q update 2>&1 > /dev/null
cd $lib/sandbox
cvs -Q update 2>&1 > /dev/null
cd $lib
cvs -Q update 2>&1 > /dev/null

# update HTML docs
cd $dest
for htmlfile in `find . -name '*.html'` ; do
    dir=`dirname $htmlfile`
    base=`basename $htmlfile .html`
    txtfile=$dir/$base.txt
    if [ -e $txtfile ] ; then
        if [ $unconditional -eq 1 -o $txtfile -nt $htmlfile ] ; then
            if [ "${base:0:4}" == "pep-" ] ; then
                echo "$txtfile (PEP)"
                ( cd $dir ; ~/bin/python $lib/tools/pep2html.py $base.txt )
            else
                echo $txtfile
                ( cd $dir ; ~/bin/python $lib/tools/html.py -gst $base.txt $base.html )
            fi
        fi
    fi
done
